# ============================================================
# å°è‚¡è·Œå¹… vs å¤–è³‡è²·è³£è¶… Dashboard â€” GitHub Actions è‡ªå‹•éƒ¨ç½²
#
# æ’ç¨‹: é€±ä¸€~äº” å°ç£æ™‚é–“ 17:30 (UTC 09:30)
#       æ­¤æ™‚ TWSE å¤–è³‡è³‡æ–™å·²æ›´æ–°ï¼Œä¸æœƒç”¢ç”Ÿæ—¥æœŸä¸åŒæ­¥å•é¡Œ
#
# æµç¨‹: åŸ·è¡Œ Python â†’ ç”¢ç”Ÿ HTML â†’ éƒ¨ç½²åˆ° gh-pages â†’ GitHub Pages ä¸Šç·š
# ============================================================

name: ğŸ“Š æ›´æ–° Dashboard

on:
  # æ’ç¨‹ï¼šé€±ä¸€åˆ°é€±äº”ï¼Œå°ç£æ™‚é–“ 17:30 (UTC 09:30)
  schedule:
    - cron: '30 9 * * 1-5'

  # æ‰‹å‹•è§¸ç™¼ï¼ˆåœ¨ Actions tab æŒ‰ Run workflowï¼‰
  workflow_dispatch:

  # push åˆ° main ä¹Ÿè§¸ç™¼ï¼ˆæ–¹ä¾¿æ¸¬è©¦ï¼‰
  push:
    branches:
      - main
    paths:
      - 'stock_foreign_dashboard.py'
      - '.github/workflows/deploy.yml'
      - 'requirements.txt'

# è¨­å®šæ¬Šé™ï¼ˆéƒ¨ç½² gh-pages éœ€è¦ writeï¼‰
permissions:
  contents: write
  pages: write

# åŒä¸€æ™‚é–“åªå…è¨±ä¸€å€‹ deployï¼ˆé¿å…è¡çªï¼‰
concurrency:
  group: deploy-dashboard
  cancel-in-progress: true

jobs:
  build-and-deploy:
    runs-on: ubuntu-latest
    # è¨­å®šæ™‚å€ï¼Œè®“ Python datetime.now() å–åˆ°å°ç£æ™‚é–“
    env:
      TZ: Asia/Taipei

    steps:
      # 1. å–å‡º repo ç¨‹å¼ç¢¼
      - name: ğŸ“¥ Checkout
        uses: actions/checkout@v4

      # 2. å®‰è£ Python
      - name: ğŸ Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.12'

      # 3. å¿«å– pip å¥—ä»¶ï¼ˆåŠ é€Ÿå¾ŒçºŒ buildï¼‰
      - name: ğŸ“¦ Cache pip
        uses: actions/cache@v4
        with:
          path: ~/.cache/pip
          key: ${{ runner.os }}-pip-${{ hashFiles('requirements.txt') }}
          restore-keys: |
            ${{ runner.os }}-pip-

      # 4. å®‰è£å¥—ä»¶
      - name: ğŸ“¦ Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install -r requirements.txt

      # 5. åŸ·è¡Œä¸»ç¨‹å¼ï¼Œç”¢ç”Ÿ HTML
      - name: ğŸš€ Run dashboard script
        run: python stock_foreign_dashboard.py

      # 6. æº–å‚™éƒ¨ç½²ç›®éŒ„ + å–å¾—å°ç£æ™‚é–“
      - name: ğŸ“ Prepare deploy directory
        run: |
          mkdir -p public
          # è¤‡è£½ HTML ç‚º index.htmlï¼ˆGitHub Pages é è¨­é¦–é ï¼‰
          cp stock_foreign_dashboard.html public/index.html
          # ä¹Ÿä¿ç•™åŸæª”åï¼ˆæ–¹ä¾¿ç›´é€£ï¼‰
          cp stock_foreign_dashboard.html public/
          # é˜²æ­¢ Jekyll è™•ç†
          touch public/.nojekyll
          # å–å¾—å°ç£æ—¥æœŸçµ¦ commit message ç”¨
          echo "TZ_DATE=$(date +'%Y/%m/%d %H:%M')" >> $GITHUB_ENV

      # 7. éƒ¨ç½²åˆ° gh-pages åˆ†æ”¯
      - name: ğŸŒ Deploy to GitHub Pages
        uses: peaceiris/actions-gh-pages@v4
        with:
          github_token: ${{ secrets.GITHUB_TOKEN }}
          publish_dir: ./public
          # commit message å¸¶ä¸Šæ—¥æœŸæ–¹ä¾¿è¿½è¹¤
          commit_message: "ğŸ“Š æ›´æ–° Dashboard - ${{ env.TZ_DATE }}"
          # å¼·åˆ¶è¦†è“‹ï¼ˆæˆ‘å€‘ä¸éœ€è¦æ­·å² HTMLï¼‰
          force_orphan: true
